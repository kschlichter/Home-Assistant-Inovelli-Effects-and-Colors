############
# Forum: https://community.home-assistant.io/t/control-leds-and-led-effects-on-inovelli-red-and-blue-dimmers-switches-and-combo-fan-lights-by-area-group-device-or-entity/421862
# Github: https://github.com/kschlichter/Home-Assistant-Inovelli-Effects-and-Colors
# ZHA LED config: https://community.inovelli.com/t/setting-blue-series-led-color-and-brightness-non-effect-in-home-assistant-zha/16417
#
# Setting the LED indicator
#   - LEDnumber: (Blue Series only; LED 1 .. LED 7 or All) Set to `all` to configure the whole LED bar (default if the parameter is left out) or configure a single LED.
#       If specific LEDs have been set, they'll need to be unset before the LED bar will show anything.  The easiest way is to call LEDnumber 'all' with LEDcolor 'all clear'.
#   - LEDcolor: (int or string) Sets color of the status LED.  If LEDcolor_off is defined and supported by the device, this is only used for "on" status.
#       If a "color set" is used like "all unicorn", LEDnumber cannot be set to "LED {n}"; "all" LEDs must be configured or none will be.
#   - LEDcolor_off: (Red 800 and Blue Series only; int or string) Sets color of status LED when off, for devices that support this feature.
#       Note that the Blue Series and Red 800 Series support separate colors for on and off while the Black 500, Red 500, and White Series devices do not and will ignore the variable.
#       If a "color set" is used like "all unicorn", LEDnumber cannot be set to "LED {n}"; "all" LEDs must be configured or none will be.
#   - LEDbrightness: (float 0.0 – 10.0) Sets the brightness of the status LED.  If LEDbrightness_off is defined and supported by the device, this is only used for "on" status.
#       LEDbrightness is multiplied by 10 or rounded off for each device, depending on whether they support 0 – 100 or 0 – 10 brightness levels.  This was done for backwards compatibility with old automations.
#   - LEDbrightness_off: (float 0.0 – 10.0) (see note above) Sets the brightness of the status LED when off.
#
# Setting LED effects
#   LEDnumber_effect: (optional; LED 1 .. LED 7 or All)Set to `all` to configure the whole LED bar (default if the parameter is left out) or configure a single LED.
#   effect: (required; string) Where older devices don't support a new effect, that effect has been mapped to something that is supported.
#   brightness: (required; float 1 – 10) Sets the brightness of the LED's effect
#   color: (required; string) Sets color of LED effect.
#   duration: (required; string or whole integer of seconds) Either "Off", an integer of seconds, or a whole integer followed by "Seconds", "Minutes", "Hours", "Indefinitely", or "Forever".

#
# Effects not working?
#   Black 500 and White Series devices do not support effects.
#   Check that your device supports the effect you're selecting at https://inovelliusa.github.io/inovelli-switch-toolbox/
#
# Convert to blueprint:
#   Switch blueprint: and script alias: lines
#   Add two spaces to lines between label: and variables: 70.625s
#   Comment out example:
#   Switch input_* and script variables (1 place)
#
# Zigbee2MQTT devices: https://www.zigbee2mqtt.io/supported-devices/#v=Inovelli
# ZHA quirks: https://github.com/zigpy/zha-device-handlers/blob/dev/zhaquirks/inovelli/__init__.py#L199
# Z-Wave Config DB: https://devices.zwave-js.io/?jumpTo=0x031e:0x0001:0x0001:0.0
# Inovelli Toolbox: https://inovelliusa.github.io/inovelli-switch-toolbox/
# Caculations: https://docs.google.com/spreadsheets/d/14wTP4OL4hkDK3Et5kYL4fyxPIK_R9JR3cgFxSa6dhyw/edit?usp=sharing
############

mode: parallel
max: 100 # Default max is 10, which might be an issue if you have a lot of switches and you're calling the script per entity for some goofy reason.


alias: Inovelli LED Settings and Effects
description: |
    Sets LED colors and effects on Inovelli "Black", "Red 500", "Red 800", "Blue", and "White" Series switches, dimmers, and fan controllers
    through the Zwave JS, ZHA, Zigbee2MQTT, and Matter integrations.  Devices from all series can be used together,
    and can be called by domain, label, floor, area, group, device, and entity.

    **Syntax and examples https://github.com/kschlichter/Home-Assistant-Inovelli-Effects-and-Colors**
fields:

  entity:
    name: Entity
    description: | 
      (entity: light.office, fan.guest_room) - The light.*, switch.*, or fan.* entity for the LED we're setting.  Can be a comma separated list of Inovelli devices.  Mix and match types as you like.
    default: []
    selector:
      entity:
        multiple: true
        filter:
          - integration: zwave_js
            domain:
              - fan
              - light
              - switch
            #model: LZW36 # Device model should really be an option for entities.
          - integration: zha
            domain:
              - fan
              - light
              - switch
          - integration: mqtt
            domain:
              - fan
              - light
              - switch
          - integration: matter
            domain:
              - fan
              - light
              - switch

  LEDnumber:
    name: LED Number
    description: |
      (LEDnumber: All) - Sets the full LED bar by default, or specific LEDs (1 – 7) starting at the bottom.
    default: 'all'
    selector:
      select:
        options:
          - All
          - LED 1
          - LED 2
          - LED 3
          - LED 4
          - LED 5
          - LED 6
          - LED 7

  LEDcolor:
    name: LED Color When On (non-effect)
    description: |
      (LEDcolor: Blue) - Sets the color of the LED status bar, which indicates brightness levels of the light.
    default: 'no change'
    selector:
      select:
        options:
          - "Off"
          - Red
          - Orange
          - Lemon
          - Yellow
          - Lime
          - Green
          - Cyan
          - Teal
          - Blue
          - Purple
          - Magenta
          - Light Pink
          - Pink
          - Hot Pink
          - White

variables:
  ##################
  # Look-up tables for easy reference and future maintenance.
  ##################
  color_set:
    "off": 0
    red: 0
    orange: 8
    lemon: 28
    yellow: 42
    lime: 64
    green: 85
    cyan: 127
    teal: 145
    blue: 170
    purple: 190
    magenta: 212
    light pink: 220
    pink: 234
    hot pink: 234
    white: 255

  ### Blue Series ZHA Quirks says 1 – 7 but it seems to be 0 – 6 ###
  led_map:
    all: -1
    led 1: 0
    led 2: 1
    led 3: 2
    led 4: 3
    led 5: 4
    led 6: 5
    led 7: 6

  ##################
  # Store model names for reference and validation checks if necessary
  ##################
  zha_models: # Blue
    - VZM30-SN # Blue Series switch
    - VZM31-SN # Blue Series dimmer
    - VZM35-SN # Blue Series fan


  ##################
  # Clean up inputs; filter for supported entities from provided floor, areas, groups, devices, and entities.
  ##################
  entity:          "{{ entity          | default([]) }}"
  
  entities_from_entity: >-
    {% set entities_from_entity = [] %}
    {% set entity_array = namespace(entity_list=[]) %}
    {% if entity != 'invalid' and entity != ['invalid'] and entity != [] and entity != '' %}
      {% if typeof(entity) == 'str' %}
        {% set entity_array.entity_list = entity.split( ',' ) | map('lower') | map('trim') | list %}
      {% else %}
        {% set entity_array.entity_list = entity | map('lower') | map('trim') | list %}
      {% endif %}
    {% endif %}

    {% set entities_from_entity = entity_array.entity_list
           | select('is_device_attr', 'manufacturer', 'Inovelli')
           | expand
           | selectattr('domain', 'in', domains_allowed )
           | map(attribute='entity_id')
           | list %}
    {{ entities_from_entity }}

  all_selected_entities: >-
    {% set all_selected_entities = [] %}
    {% set selectors = [ entities_from_entity ]
                         | reject('equalto', [])
                         | list %}
    {% set all_selected_entities = selectors | flatten | unique | list %}
    {{ all_selected_entities }}


sequence:

  ##################
  # Cleaning up other variables; using lower case since it's able to handle capital letters in the middle of mistyped and camelcase words like "LightPink".
  # Brightness variables are set to 11 so they're skipped in the logic.  To turn the LED off, use "Off".
  ##################
  - variables:
      entity:          "{{ entity }}"

      LEDnumber:         "{{ LEDnumber         | default('all')          | lower }}"
      LEDcolor:          "{{ LEDcolor          | default('no change')    | lower }}"


  ##################
  # Group entities by device type so the right integration and parameters can be used
  ##################
  - repeat:
      for_each:

        ##################
        # ZHA Zigbee Home Automation
        ##################
        - device_type: VZM30SN
          call_type: zha
          effects: "{{ 'banana' }}" 
          entities: >-
            {% set entities = namespace(entities=[]) %}
            {% for ent in all_selected_entities %}
              {% if 'VZM30-SN' in device_attr(ent,'model') and ent.split('.')[0] == 'light' and ent in integration_entities('zha') %}
                {% set entities.entities = entities.entities + [ent] %} 
              {% endif %}
            {% endfor %}
            {{ entities.entities }}

        - device_type: VZM31SN
          call_type: zha
          effects: "{{ 'banana' }}"
          entities: >-
            {% set entities = namespace(entities=[]) %}
            {% for ent in all_selected_entities %}
              {% if 'VZM31-SN' in device_attr(ent,'model') and ent.split('.')[0] == 'light' and ent in integration_entities('zha') %}
                {% set entities.entities = entities.entities + [ent] %}
              {% endif %}
            {% endfor %}
            {{ entities.entities }}

        - device_type: VZM35SN
          call_type: zha
          effects: "{{ 'banana' }}"
          entities: >-
            {% set entities = namespace(entities=[]) %}
            {% for ent in all_selected_entities %}
              {% if 'VZM35-SN' in device_attr(ent,'model') and ent.split('.')[0] == 'fan' and ent in integration_entities('zha') %}
                {% set entities.entities = entities.entities + [ent] %}
              {% endif %}
            {% endfor %}
            {{ entities.entities }}


      sequence:
        ##################
        # Do not continue if we don't have at least one entity of this type
        ##################
        - condition: template
          value_template: "{{ (repeat.item.entities | count >0) or (repeat.item.effect_entities | count >0) }}"

        ##################
        # LED strip color
        ##################
        - choose:
            - conditions: "{{ LEDcolor != 'no change' }}"
              sequence:

                ### ZHA ###
                - choose:
                    - conditions: "{{ repeat.item.call_type == 'zha' }}"
                      sequence:
                        - repeat:
                            for_each: "{{ repeat.item.entities  | select('match', domains_allowed) | list }}"
                            sequence:
                              - choose:
                                  ### Configuring a color set for all LEDs ###
                                  - conditions: "{{ 'all' in LEDcolor and LEDnumber == 'all' }}"
                                    sequence:
                                      - variables:
                                          entity: "{{ repeat.item | select('match', domains_allowed) | list }}"
                                      - repeat:
                                          for_each:
                                            - "led 1"
                                            - "led 2"
                                            - "led 3"
                                            - "led 4"
                                            - "led 5"
                                            - "led 6"
                                            - "led 7"
                                            - "all"
                                          sequence:
                                            - service: zha.set_zigbee_cluster_attribute
                                              continue_on_error: true
                                              data:
                                                ieee: "{{ (device_attr( entity, 'identifiers') | list).0.1 }}"
                                                endpoint_id: 1
                                                cluster_id: 64561
                                                cluster_type: in
                                                attribute: >-
                                                  {% if repeat.item == 'all' %}
                                                    {{ 0x005f |int }}
                                                  {% elif repeat.item == 'led 1' %}
                                                    {{ 0x003c |int }}
                                                  {% elif repeat.item == 'led 2' %}
                                                    {{ 0x0041 |int }}
                                                  {% elif repeat.item == 'led 3' %}
                                                    {{ 0x0046 |int }}
                                                  {% elif repeat.item == 'led 4' %}
                                                    {{ 0x004b |int }}
                                                  {% elif repeat.item == 'led 5' %}
                                                    {{ 0x0050 |int }}
                                                  {% elif repeat.item == 'led 6' %}
                                                    {{ 0x0055 |int }}
                                                  {% elif repeat.item == 'led 7' %}
                                                    {{ 0x005a |int }}
                                                  {% endif %}
                                                value: "{{ color_set[LEDcolor][repeat.item] }}"
                                                manufacturer: 4655
                                  ### Configuring just one LED or the full bar ###
                                  - conditions: "{{ 'all' not in LEDcolor and LEDcolor != 'no change' }}"
                                    sequence:
                                      - service: zha.set_zigbee_cluster_attribute
                                        continue_on_error: true
                                        data:
                                          ieee: "{{ (device_attr( repeat.item, 'identifiers') | list).0.1 }}"
                                          endpoint_id: 1
                                          cluster_id: 64561
                                          cluster_type: in
                                          attribute: >-
                                            {% if LEDnumber == 'all' %}
                                              {{ 0x005f |int }}
                                            {% elif LEDnumber == 'led 1' %}
                                              {{ 0x003c |int }}
                                            {% elif LEDnumber == 'led 2' %}
                                              {{ 0x0041 |int }}
                                            {% elif LEDnumber == 'led 3' %}
                                              {{ 0x0046 |int }}
                                            {% elif LEDnumber == 'led 4' %}
                                              {{ 0x004b |int }}
                                            {% elif LEDnumber == 'led 5' %}
                                              {{ 0x0050 |int }}
                                            {% elif LEDnumber == 'led 6' %}
                                              {{ 0x0055 |int }}
                                            {% elif LEDnumber == 'led 7' %}
                                              {{ 0x005a |int }}
                                            {% endif %}
                                          ### Individual LEDs use 255 for 'off' while it's 'white' for the LED bar ###
                                          value: >-
                                            {% if 'led' in LEDnumber and LEDcolor == 'off' %}
                                              255
                                            {% else %}
                                              {{ color_set[LEDcolor] }}
                                            {% endif %}
                                          manufacturer: 4655
