############
# Forum: https://community.home-assistant.io/t/control-leds-and-led-effects-on-inovelli-red-and-blue-dimmers-switches-and-combo-fan-lights-by-area-group-device-or-entity/421862
# Github: https://github.com/kschlichter/Home-Assistant-Inovelli-Effects-and-Colors
# ZHA LED config: https://community.inovelli.com/t/setting-blue-series-led-color-and-brightness-non-effect-in-home-assistant-zha/16417
#
# Setting the LED indicator
#   - LEDnumber: (Blue Series only; LED 1 .. LED 7 or All) Set to `all` to configure the whole LED bar (default if the parameter is left out) or configure a single LED.
#       If specific LEDs have been set, they'll need to be unset before the LED bar will show anything.  The easiest way is to call LEDnumber 'all' with LEDcolor 'all clear'.
#   - LEDcolor: (int or string) Sets color of the status LED.  If LEDcolor_off is defined and supported by the device, this is only used for "on" status.
#       If a "color set" is used like "all unicorn", LEDnumber cannot be set to "LED {n}"; "all" LEDs must be configured or none will be.
#   - LEDcolor_off: (Red 800 and Blue Series only; int or string) Sets color of status LED when off, for devices that support this feature.
#       Note that the Blue Series and Red 800 Series support separate colors for on and off while the Black 500, Red 500, and White Series devices do not and will ignore the variable.
#       If a "color set" is used like "all unicorn", LEDnumber cannot be set to "LED {n}"; "all" LEDs must be configured or none will be.
#   - LEDbrightness: (float 0.0 – 10.0) Sets the brightness of the status LED.  If LEDbrightness_off is defined and supported by the device, this is only used for "on" status.
#       LEDbrightness is multiplied by 10 or rounded off for each device, depending on whether they support 0 – 100 or 0 – 10 brightness levels.  This was done for backwards compatibility with old automations.
#   - LEDbrightness_off: (float 0.0 – 10.0) (see note above) Sets the brightness of the status LED when off.
#
# Setting LED effects
#   LEDnumber_effect: (optional; LED 1 .. LED 7 or All)Set to `all` to configure the whole LED bar (default if the parameter is left out) or configure a single LED.
#   effect: (required; string) Where older devices don't support a new effect, that effect has been mapped to something that is supported.
#   brightness: (required; float 1 – 10) Sets the brightness of the LED's effect
#   color: (required; string) Sets color of LED effect.
#   duration: (required; string or whole integer of seconds) Either "Off", an integer of seconds, or a whole integer followed by "Seconds", "Minutes", "Hours", "Indefinitely", or "Forever".

#
# Effects not working?
#   Black 500 and White Series devices do not support effects.
#   Check that your device supports the effect you're selecting at https://inovelliusa.github.io/inovelli-switch-toolbox/
#
# Convert to blueprint:
#   Switch blueprint: and script alias: lines
#   Add two spaces to lines between label: and variables: 70.625s
#   Comment out example:
#   Switch input_* and script variables (1 place)
#
# Zigbee2MQTT devices: https://www.zigbee2mqtt.io/supported-devices/#v=Inovelli
# ZHA quirks: https://github.com/zigpy/zha-device-handlers/blob/dev/zhaquirks/inovelli/__init__.py#L199
# Z-Wave Config DB: https://devices.zwave-js.io/?jumpTo=0x031e:0x0001:0x0001:0.0
# Inovelli Toolbox: https://inovelliusa.github.io/inovelli-switch-toolbox/
# Caculations: https://docs.google.com/spreadsheets/d/14wTP4OL4hkDK3Et5kYL4fyxPIK_R9JR3cgFxSa6dhyw/edit?usp=sharing
############

mode: parallel
max: 100 # Default max is 10, which might be an issue if you have a lot of switches and you're calling the script per entity for some goofy reason.


#blueprint:
#  name: Inovelli LED Settings and Effects Blueprint
#  domain: script
#  source_url: https://github.com/kschlichter/Home-Assistant-Inovelli-Effects-and-Colors/blob/Blueprint/blueprints/script/kschlichter/inovelli_led_blueprint.yaml
#  author: "Kevin Schlichter"
#  description: |
#    Sets LED colors and effects on Inovelli "Black", "Red 500", "Red 800", "Blue", and "White" Series switches, dimmers, and fan controllers
#    through the Zwave JS, ZHA, Zigbee2MQTT, and Matter integrations.  Devices from all series can be used together,
#    and can be called by domain, label, floor, area, group, device, and entity.
#
#    Syntax and examples: https://github.com/kschlichter/Home-Assistant-Inovelli-Effects-and-Colors
#  homeassistant:
#    min_version: 2025.04.0
#  input:

alias: Inovelli LED Settings and Effects
description: |
    Sets LED colors and effects on Inovelli "Black", "Red 500", "Red 800", "Blue", and "White" Series switches, dimmers, and fan controllers
    through the Zwave JS, ZHA, Zigbee2MQTT, and Matter integrations.  Devices from all series can be used together,
    and can be called by domain, label, floor, area, group, device, and entity.

    **Syntax and examples https://github.com/kschlichter/Home-Assistant-Inovelli-Effects-and-Colors**
fields:

  selector_mode:
    name: Selector Mode
    description: |
      (selector_mode: 'any') - Select devices that meet ANY requirements (logical OR)  or ALL requirements (logical AND).
    #required: false
    default: 'any'
    selector:
      select:
        multiple: false
        options:
          - "any"
          - "all"

  z2m_topic:
    name: Zigbee2MQTT Topic
    description: |
      (z2m_topic: 'zigbee2mqtt') - Topic (string) used to identify and route messages within the MQTT protocol
    #required: false
    default: 'zigbee2mqtt'
    selector:
      text:
        multiple: false
        type: text

  allowed_domains:
    name: Allowed Domain
    description: |
      (allowed_domains: 'light, fan') - Only allow entities of the following type.
    #required: false
    default: ['fan','light','switch']
    selector:
      select:
        multiple: true
        options:
          - "fan"
          - "light"
          - "switch"

  domain:
    name: Domain
    description: |
      (domain: 'light, fan') - Select and include all entities of this domain type.
    #required: false
    default: []
    selector:
      select:
        multiple: true
        options:
          - "fan"
          - "light"
          - "switch"

  label:
    name: Label
    description: |
      (label: 'christmas lights, bedrooms, fans') - Labels on Inovelli devices and entities, or areas containing Inovelli devices.
    #required: false
    default: []
    selector:
      label:
        multiple: true

  floor:
    name: Floor
    description: |
      (floor: 'downstairs, upstairs, outside') - Floor IDs containing areas with Inovelli devices.  
    #required: false
    default: []
    selector:
      floor:
        multiple: true
        device:
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW30
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW31
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW30-SN
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW31-SN
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW36
          - integration: zwave_js
            manufacturer: Inovelli
            model: VZW31-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM30-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM31-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM35-SN
          - integration: mqtt
            manufacturer: Inovelli
            model: 2-in-1 switch + dimmer (VZM31-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Fan Controller (VZM35-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Inovelli 2-in-1 switch + dimmer (VZM31-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Inovelli Fan Controller (VZM35-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: On/off switch
          - integration: mqtt
            manufacturer: Inovelli
            model: 2-in-1 switch + dimmer
          - integration: mqtt
            manufacturer: Inovelli
            model: Fan controller
          - integration: matter
            manufacturer: Inovelli
            model: White Series Smart 2-1 Switch
          - integration: matter
            manufacturer: Inovelli
            model: White Series Smart Fan Switch

  area:
    name: Area
    description: |
      (area: 'Family Room, 7d7a44fe4d0f4bee947c430d2714e45c') - Area names or IDs containing Inovelli devices.
    #required: false
    default: []
    selector:
      area:
        multiple: true
        device:
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW30
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW31
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW30-SN
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW31-SN
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW36
          - integration: zwave_js
            manufacturer: Inovelli
            model: VZW31-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM30-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM31-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM35-SN
          - integration: mqtt
            manufacturer: Inovelli
            model: 2-in-1 switch + dimmer (VZM31-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Fan Controller (VZM35-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Inovelli 2-in-1 switch + dimmer (VZM31-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Inovelli Fan Controller (VZM35-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: On/off switch
          - integration: mqtt
            manufacturer: Inovelli
            model: 2-in-1 switch + dimmer
          - integration: mqtt
            manufacturer: Inovelli
            model: Fan controller
          - integration: matter
            manufacturer: Inovelli
            model: White Series Smart 2-1 Switch
          - integration: matter
            manufacturer: Inovelli
            model: White Series Smart Fan Switch

  group:
    name: Group
    description: |
      (group: 'group.lights_and_switches, 0249abdc634c12cbf6cdc06d7a507495') - Group names or IDs for groups containing Inovelli devices.  Mix and match types as you like.
    #required: false
    default: []
    selector:
      entity:
        multiple: true
        filter:
          - domain:
              - group
              - fan
              - light
              - switch

  device:
    name: Device
    description: |
      (device: '0249abdc634c12cbf6cdc06d7a507495') - Device IDs of Inovelli devices.  Mix and match types as you like.
    default: []
    selector:
      device:
        multiple: true
        filter:
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW30
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW31
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW30-SN
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW31-SN
          - integration: zwave_js
            manufacturer: Inovelli
            model: LZW36
          - integration: zwave_js
            manufacturer: Inovelli
            model: VZW31-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM30-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM31-SN
          - integration: zha
            manufacturer: Inovelli
            model: VZM35-SN
          - integration: mqtt
            manufacturer: Inovelli
            model: 2-in-1 switch + dimmer (VZM31-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Fan Controller (VZM35-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Inovelli 2-in-1 switch + dimmer (VZM31-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: Inovelli Fan Controller (VZM35-SN)
          - integration: mqtt
            manufacturer: Inovelli
            model: On/off switch
          - integration: mqtt
            manufacturer: Inovelli
            model: 2-in-1 switch + dimmer
          - integration: mqtt
            manufacturer: Inovelli
            model: Fan controller
          - integration: matter
            manufacturer: Inovelli
            model: White Series Smart 2-1 Switch
          - integration: matter
            manufacturer: Inovelli
            model: White Series Smart Fan Switch

  entity:
    name: Entity
    description: | 
      (entity: light.office, fan.guest_room) - The light.*, switch.*, or fan.* entity for the LED we're setting.  Can be a comma separated list of Inovelli devices.  Mix and match types as you like.
    default: []
    selector:
      entity:
        multiple: true
        filter:
          - integration: zwave_js
            domain:
              - fan
              - light
              - switch
            #model: LZW36 # Device model should really be an option for entities.
          - integration: zha
            domain:
              - fan
              - light
              - switch
          - integration: mqtt
            domain:
              - fan
              - light
              - switch
          - integration: matter
            domain:
              - fan
              - light
              - switch

  LEDnumber:
    name: LED Number
    description: |
      (LEDnumber: All) - Sets the full LED bar by default, or specific LEDs (1 – 7) starting at the bottom.
    default: 'all'
    selector:
      select:
        options:
          - All
          - LED 1
          - LED 2
          - LED 3
          - LED 4
          - LED 5
          - LED 6
          - LED 7

  LEDcolor:
    name: LED Color When On (non-effect)
    description: |
      (LEDcolor: Blue) - Sets the color of the LED status bar, which indicates brightness levels of the light.
    default: 'no change'
    selector:
      select:
        options:
          - "Off"
          - Red
          - Orange
          - Lemon
          - Yellow
          - Lime
          - Green
          - Cyan
          - Teal
          - Blue
          - Purple
          - Magenta
          - Light Pink
          - Pink
          - Hot Pink
          - White
          - All Clear
          - All Unicorn
          - All USA
          - All Custom On

  LEDcolor_custom:
    name: LED Color Custom Dict When On (non-effect). Blue Series only.
    description: |
      (LEDcolor_custom: "{'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}") - Sets the color of the LED status bar to a custom dictionary, which indicates brightness levels of the light.
    default: {'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}
    selector:
      text:
        multiline: true
        prefix: "{'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}"
        type: text
        multiple: false

  LEDcolor_off:
    name: LED Color When Off (non-effect). Red 800 and Blue Series only.
    description: |
      (LEDcolor_off: Blue) - Sets the color of the LED status bar to a custom dictionary, which indicates brightness levels of the light.
    default: 'no change'
    selector:
      select:
        options:
          - "Off"
          - Red
          - Orange
          - Lemon
          - Yellow
          - Lime
          - Green
          - Cyan
          - Teal
          - Blue
          - Purple
          - Magenta
          - Light Pink
          - Pink
          - Hot Pink
          - White
          - All Clear
          - All Unicorn
          - All USA
          - All Custom Off

  LEDcolor_off_custom:
    name: LED Color Custom Dict When Off (non-effect). Blue Series only.
    description: |
      (LEDcolor_off_custom: "{'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}") - Sets the color of the LED status bar to a custom dictionary, which indicates brightness levels of the light.
    default: {'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}
    selector:
      text:
        multiline: true
        prefix: "{'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}"
        type: text
        multiple: false

  LEDbrightness:
    name: LED Brightness When On (non-effect)
    description: |
      (LEDbrightness: 6) - Sets the brightness of the LED status when on. 0 means off.
    default: 11
    selector:
      number:
        min: 0
        max: 10
        step: 0.1
        mode: slider

  LEDbrightness_off:
    name: LED Brightness When Off (non-effect).
    description: |
      (LEDbrightness_off: 2) - Sets the brightness of the LED status when off. 0 means off.
    default: 11
    selector:
      number:
        min: 0
        max: 10
        step: 0.1
        mode: slider

  LEDnumber_effect:
    name: LED Number for Effects
    description: |
      (LEDnumber_effect: All) - Sets the effect on the full LED bar by default, or specific LEDs (1 – 7) starting at the bottom. (Red 800, and Blue Series only.  Black and Red 500 Series devices do not support effects on individual LEDs)
    default: 'all'
    selector:
      select:
        options:
          - All
          - LED 1
          - LED 2
          - LED 3
          - LED 4
          - LED 5
          - LED 6
          - LED 7

  effect:
    name: Effect
    description: |
      (effect: Pulse) - Type of effect. (Red and Blue Series only.  Black Series devices do not support effects) 
    default: 'Clear Effect'
    selector:
      select:
        options:
          - "Off"
          - Clear Effect
          - Aurora
          - Blink Fast
          - Blink Medium
          - Blink Slow
          - Chase Fast
          - Chase Medium
          - Chase Slow
          - Fall Fast
          - Fall Medium
          - Fall Slow
          - Open Close
          - Pulse
          - Rise Fast
          - Rise Medium
          - Rise Slow
          - Siren Fast
          - Siren Slow
          - Small to Big
          - Solid

  brightness:
    name: Effect Brightness
    description: |
      (brightness: "8") - Sets the brightness of the LED's effect.  0 means off.
    default: '11'
    selector:
      number:
        min: 0
        max: 10
        step: 0.1
        mode: slider

  color:
    name: Effect Color
    description: |
      (color: Red) - Color of LED for the effect
    default: 'no change'
    selector:
      select:
        options:
          - "Off"
          - Red
          - Orange
          - Lemon
          - Yellow
          - Lime
          - Green
          - Cyan
          - Teal
          - Blue
          - Purple
          - Magenta
          - Light Pink
          - Pink
          - Hot Pink
          - White

  duration:
    name: Duration of Effect
    description: |
      (duration: "Off") - How long the effect will last.
    default: '0'
    selector:
      select:
        options:
          - "Off"
          - Forever
          - 1 Second
          - 2 Seconds
          - 3 Seconds
          - 4 Seconds
          - 5 Seconds
          - 6 Seconds
          - 7 Seconds
          - 8 Seconds
          - 9 Seconds
          - 10 Seconds
          - 15 Seconds
          - 20 Seconds
          - 25 Seconds
          - 30 Seconds
          - 35 Seconds
          - 40 Seconds
          - 45 Seconds
          - 50 Seconds
          - 55 Seconds
          - 60 Seconds
          - 2 Minutes
          - 3 Minutes
          - 4 Minutes
          - 5 Minutes
          - 6 Minutes
          - 7 Minutes
          - 8 Minutes
          - 9 Minutes
          - 10 Minutes
          - 15 Minutes
          - 30 Minutes
          - 45 Minutes
          - 1 Hour
          - 2 Hours
          - Indefinitely


variables:
  ##################
  # Look-up tables for easy reference and future maintenance.
  ##################
  color_set:
    "off": 0
    red: 0
    orange: 8
    lemon: 28
    yellow: 42
    lime: 64
    green: 85
    cyan: 127
    teal: 145
    blue: 170
    purple: 190
    magenta: 212
    light pink: 220
    pink: 234
    hot pink: 234
    white: 255
    "all clear": {'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}
    "all unicorn": {'led 1':234,'led 2':234,'led 3':170,'led 4':170,'led 5':170,'led 6':85,'led 7':85,'all':0}
    "all usa": {'led 1':170,'led 2':170,'led 3':255,'led 4':255,'led 5':0,'led 6':0,'led 7':0,'all':255}
    "all custom on": "{{ LEDcolor_custom | default({'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}) }}"
    "all custom off": "{{ LEDcolor_off_custom | default({'led 1':255,'led 2':255,'led 3':255,'led 4':255,'led 5':255,'led 6':255,'led 7':255,'all':0}) }}"

  ### Blue Series ZHA Quirks says 1 – 7 but it seems to be 0 – 6 ###
  led_map:
    all: -1
    led 1: 0
    led 2: 1
    led 3: 2
    led 4: 3
    led 5: 4
    led 6: 5
    led 7: 6

  duration_values:
    "off": 0
    0 : 0
    1 second: 1
    1 seconds: 1
    2 seconds: 2
    3 seconds: 3
    4 seconds: 4
    5 seconds: 5
    6 seconds: 6
    7 seconds: 7
    8 seconds: 8
    9 seconds: 9
    10 seconds: 10
    15 seconds: 15
    20 seconds: 20
    25 seconds: 25
    30 seconds: 30
    35 seconds: 35
    40 seconds: 40
    45 seconds: 45
    50 seconds: 50
    55 seconds: 55
    60 seconds: 60
    1 minute: 60
    1 minutes: 60
    2 minutes: 62
    3 minutes: 63
    4 minutes: 64
    5 minutes: 65
    6 minutes: 66
    7 minutes: 67
    8 minutes: 68
    9 minutes: 69
    10 minutes: 70
    15 minutes: 75
    30 minutes: 90
    45 minutes: 105
    60 minutes: 120
    1 hour: 120
    2 hours: 122
    forever: 255
    indefinitely: 255

  ### Blue Series Switch ###
  VZM30SN_ZHA_all_effects:
    "off": 0
    clear effect: 255
    aurora: 8
    blink: 15
    blink fast: 2
    blink medium: 15
    blink slow: 3
    chase: 5
    chase fast: 17
    chase medium: 5
    chase slow: 16
    fall fast: 11
    fall medium: 10
    fall slow: 9
    open close: 6
    pulse: 4
    rise fast: 14
    rise medium: 13
    rise slow: 12
    siren fast: 18
    siren slow: 19
    small to big: 7
    solid: 1
    fast blink: 2
    slow blink: 3

  VZM30SN_ZHA_led_effects:
    "off": 0
    clear effect: 255
    aurora: 8
    blink: 2
    blink fast: 2
    blink medium: 2
    blink slow: 3
    chase: 5
    chase fast: 5
    chase medium: 5
    chase slow: 5
    fall fast: 6
    fall medium: 6
    fall slow: 6
    open close: 4
    pulse: 4
    rise fast: 7
    rise medium: 7
    rise slow: 7
    siren fast: 2
    siren slow: 3
    small to big: 5
    solid: 1
    fast blink: 2
    slow blink: 3

  ### Blue Series Dimmer ###
  VZM31SN_ZHA_all_effects:
    "off": 0
    clear effect: 255
    aurora: 8
    blink: 15
    blink fast: 2
    blink medium: 15
    blink slow: 3
    chase: 5
    chase fast: 17
    chase medium: 5
    chase slow: 16
    fall fast: 11
    fall medium: 10
    fall slow: 9
    open close: 6
    pulse: 4
    rise fast: 14
    rise medium: 13
    rise slow: 12
    siren fast: 18
    siren slow: 19
    small to big: 7
    solid: 1
    fast blink: 2
    slow blink: 3

  VZM31SN_ZHA_led_effects:
    "off": 0
    clear effect: 255
    aurora: 8
    blink: 2
    blink fast: 2
    blink medium: 2
    blink slow: 3
    chase: 5
    chase fast: 5
    chase medium: 5
    chase slow: 5
    fall fast: 6
    fall medium: 6
    fall slow: 6
    open close: 4
    pulse: 4
    rise fast: 7
    rise medium: 7
    rise slow: 7
    siren fast: 2
    siren slow: 3
    small to big: 5
    solid: 1
    fast blink: 2
    slow blink: 3

  ### Blue Series Fan ###
  VZM35SN_ZHA_all_effects:
    "off": 0
    clear effect: 255
    aurora: 8
    blink: 15
    blink fast: 2
    blink medium: 15
    blink slow: 3
    chase: 5
    chase fast: 17
    chase medium: 5
    chase slow: 16
    fall fast: 11
    fall medium: 10
    fall slow: 9
    open close: 6
    pulse: 4
    rise fast: 14
    rise medium: 13
    rise slow: 12
    siren fast: 18
    siren slow: 19
    small to big: 7
    solid: 1
    fast blink: 2
    slow blink: 3

  VZM35SN_ZHA_led_effects:
    "off": 0
    clear effect: 255
    aurora: 8
    blink: 2
    blink fast: 2
    blink medium: 2
    blink slow: 3
    chase: 5
    chase fast: 5
    chase medium: 5
    chase slow: 5
    fall fast: 6
    fall medium: 6
    fall slow: 6
    open close: 4
    pulse: 4
    rise fast: 7
    rise medium: 7
    rise slow: 7
    siren fast: 2
    siren slow: 3
    small to big: 5
    solid: 1
    fast blink: 2
    slow blink: 3


  ##################
  # Store model names for reference and validation checks if necessary
  ##################
  zha_models: # Blue
    - VZM30-SN # Blue Series switch
    - VZM31-SN # Blue Series dimmer
    - VZM35-SN # Blue Series fan

  ##################
  # There's a lot of redundancy here, but it should be easy to update if parameter names change for one model and not another
  ##################
  parameters:
    LZW30_all_effect_bulk: "null"
    LZW30_all_effect_color: "null"
    LZW30_all_effect_brightness: "null"
    LZW30_all_effect_duration: "null"
    LZW30_all_effect_effect: "null"
    LZW30_all_ledcolor: "LED Indicator Color"
    LZW30_all_ledbrightness: "LED Indicator Intensity (When on)"
    LZW30_all_ledbrightness_off: "LED Indicator Intensity (When Off)"

    LZW31_all_effect_bulk: "null"
    LZW31_all_effect_color: "null"
    LZW31_all_effect_brightness: "null"
    LZW31_all_effect_duration: "null"
    LZW31_all_effect_effect: "null"
    LZW31_all_ledcolor: "LED Indicator Color"
    LZW31_all_ledbrightness: "LED Indicator Intensity"
    LZW31_all_ledbrightness_off: "LED Indicator Intensity (When Off)"

    LZW31SN_all_effect_bulk: 16
    LZW31SN_all_effect_color: "LED Indicator: Effect Color"
    LZW31SN_all_effect_brightness: "LED Indicator: Effect Brightness"
    LZW31SN_all_effect_duration: "LED Indicator: Effect Duration"
    LZW31SN_all_effect_effect: "LED Indicator: Effect Type"
    LZW31SN_all_ledcolor: "LED Indicator: Color"
    LZW31SN_all_ledbrightness: "LED Indicator: Brightness When On"
    LZW31SN_all_ledbrightness_off: "LED Indicator: Brightness When Off"

    LZW30SN_all_effect_bulk: 8
    LZW30SN_all_effect_color: LED Effect Color
    LZW30SN_all_effect_brightness: LED Effect Brightness
    LZW30SN_all_effect_duration: LED Effect Duration
    LZW30SN_all_effect_effect: LED Effect Type
    LZW30SN_all_ledcolor: LED Indicator Color
    LZW30SN_all_ledbrightness: LED Indicator Brightness
    LZW30SN_all_ledbrightness_off: LED Indicator Brightness When Off

    LZW36_light_all_effect_bulk: 24
    LZW36_light_all_effect_color: Light LED Effect Color
    LZW36_light_all_effect_brightness: Light LED Effect Brightness
    LZW36_light_all_effect_duration: Light LED Effect Duration
    LZW36_light_all_effect_effect: Light LED Effect Type
    LZW36_light_all_ledcolor: Light LED Indicator Color
    LZW36_light_all_ledbrightness: Light LED Strip Brightness
    LZW36_light_all_ledbrightness_off: Light LED Strip Brightness When Off

    LZW36_fan_all_effect_bulk: 25
    LZW36_fan_all_effect_color: Fan LED Effect Color
    LZW36_fan_all_effect_brightness: Fan LED Effect Brightness
    LZW36_fan_all_effect_duration: Fan LED Effect Duration
    LZW36_fan_all_effect_effect: Fan LED Effect Type
    LZW36_fan_all_ledcolor: Fan LED Indicator Color
    LZW36_fan_all_ledbrightness: Fan LED Strip Brightness
    LZW36_fan_all_ledbrightness_off: Fan LED Strip Brightness When Off

    VZW31SN_all_effect_bulk: 99
    VZW31SN_all_effect_color: All LED Strip Effect - Color
    VZW31SN_all_effect_brightness: All LED Strip Effect - Level
    VZW31SN_all_effect_duration: All LED Strip Effect - Duration
    VZW31SN_all_effect_effect: All LED Strip Effect - Effect
    VZW31SN_all_ledcolor: Default All LED Strip Color When On
    VZW31SN_all_ledcolor_off: Default All LED Strip Color When Off
    VZW31SN_all_ledbrightness: Default All LED Strip Brightness When On
    VZW31SN_all_ledbrightness_off: Default All LED Strip Brightness When Off

    VZW31SN_1_effect_bulk: 64
    VZW31SN_1_effect_color: LED1 Strip Effect - Color
    VZW31SN_1_effect_brightness: LED1 Strip Effect - Level
    VZW31SN_1_effect_duration: LED1 Strip Effect - Duration
    VZW31SN_1_effect_effect: LED1 Strip Effect - Effect
    VZW31SN_2_effect_bulk: 69
    VZW31SN_2_effect_color: LED2 Strip Effect - Color
    VZW31SN_2_effect_brightness: LED2 Strip Effect - Level
    VZW31SN_2_effect_duration: LED2 Strip Effect - Duration
    VZW31SN_2_effect_effect: LED2 Strip Effect - Effect
    VZW31SN_3_effect_bulk: 74
    VZW31SN_3_effect_color: LED3 Strip Effect - Color
    VZW31SN_3_effect_brightness: LED3 Strip Effect - Level
    VZW31SN_3_effect_duration: LED3 Strip Effect - Duration
    VZW31SN_3_effect_effect: LED3 Strip Effect - Effect
    VZW31SN_4_effect_bulk: 79
    VZW31SN_4_effect_color: LED4 Strip Effect - Color
    VZW31SN_4_effect_brightness: LED4 Strip Effect - Level
    VZW31SN_4_effect_duration: LED4 Strip Effect - Duration
    VZW31SN_4_effect_effect: LED4 Strip Effect - Effect
    VZW31SN_5_effect_bulk: 84
    VZW31SN_5_effect_color: LED5 Strip Effect - Color
    VZW31SN_5_effect_brightness: LED5 Strip Effect - Level
    VZW31SN_5_effect_duration: LED5 Strip Effect - Duration
    VZW31SN_5_effect_effect: LED5 Strip Effect - Effect
    VZW31SN_6_effect_bulk: 89
    VZW31SN_6_effect_color: LED6 Strip Effect - Color
    VZW31SN_6_effect_brightness: LED6 Strip Effect - Level
    VZW31SN_6_effect_duration: LED6 Strip Effect - Duration
    VZW31SN_6_effect_effect: LED6 Strip Effect - Effect
    VZW31SN_7_effect_bulk: 94
    VZW31SN_7_effect_color: LED7 Strip Effect - Color
    VZW31SN_7_effect_brightness: LED7 Strip Effect - Level
    VZW31SN_7_effect_duration: LED7 Strip Effect - Duration
    VZW31SN_7_effect_effect: LED7 Strip Effect - Effect


  ##################
  # Clean up inputs; filter for supported entities from provided floor, areas, groups, devices, and entities.
  ##################
  #selector_mode:     !input selector_mode
  #input_z2m_topic:   !input z2m_topic
  #z2m_topic:         "{{ input_z2m_topic | default('zigbee2mqtt') }}"
  #allowed_domains:   !input allowed_domains
  #domain:            !input domain
  #label:             !input label
  #floor:             !input floor
  #area:              !input area
  #group:             !input group
  #device:            !input device
  #entity:            !input entity

  #LEDnumber:         !input LEDnumber
  #LEDcolor:          !input LEDcolor
  #LEDcolor_off:      !input LEDcolor_off
  #LEDbrightness:     !input LEDbrightness
  #LEDbrightness_off: !input LEDbrightness_off
  #LEDnumber_effect:  !input LEDnumber_effect
  #effect:            !input effect
  #brightness:        !input brightness
  #color:             !input color
  #duration:          !input duration

  selector_mode:   "{{ selector_mode   | default('any') }}"
  z2m_topic:       "{{ z2m_topic       | default('zigbee2mqtt') }}"
  allowed_domains: "{{ allowed_domains | default([]) }}"
  domain:          "{{ domain          | default([]) }}"
  label:           "{{ label           | default([]) }}"
  floor:           "{{ floor           | default([]) }}"
  area:            "{{ area            | default([]) }}"
  group:           "{{ group           | default([]) }}"
  device:          "{{ device          | default([]) }}"
  entity:          "{{ entity          | default([]) }}"


  domains_allowed: >-
    {% set domains_allowed = [] %}
    {% if allowed_domains == 'invalid' or allowed_domains == ['invalid'] or allowed_domains == [] or allowed_domains == '' %}
      {% set domains_allowed = ['fan', 'light', 'switch'] %}
    {% elif typeof(allowed_domains) == 'list' or typeof(allowed_domains) == 'Wrapper' %}
      {% set domains_allowed = allowed_domains | map('lower') | map('trim') | list %}
    {% elif typeof(allowed_domains) == 'str' %}
      {% set domains_allowed = allowed_domains.split( ',' ) | map('lower') | map('trim') | list %}
    {% endif %}
    {{ domains_allowed }}

  entities_from_domain: >-
    {% set domain_list = [] %}
    {% if domain == 'invalid' or domain == ['invalid'] or domain == [] or domain == '' %}
      {% set domain_list = [] %}
    {% elif typeof(domain) == 'list' %}
      {% set domain_list = domain 
             | map('lower') 
             | map('trim') 
             | reject('equalto', 'invalid') 
             | reject('equalto', '') 
             | list %}
    {% elif typeof(domain) == 'str' %}
      {% set domain_list = domain.split( ',' ) 
             | map('lower') 
             | map('trim') 
             | reject('equalto', 'invalid') 
             | reject('equalto', '') 
             | list %}
    {% endif %}

    {% set entities = [] %}
    {% if domain_list != [] %}
      {% set entities = states
             | selectattr('domain', 'in', domain_list )
             | selectattr('domain', 'in', domains_allowed )
             | selectattr('entity_id', 'is_device_attr', 'manufacturer', 'Inovelli')
             | map(attribute='entity_id')
             | list %}
    {% else %}
      {% set entities = [] %}
    {% endif %}
    {{ entities }}

  label_list: >-
    {% set label_list=[] %}
    {% if label == 'invalid' or label == ['invalid'] %}
      {% set label_list = [] %}
    {% elif typeof(label) == 'list' %}
      {% set label_list = label | map('trim') | list %}
    {% elif label is string %}
      {% set label_list = label.split( ',' ) | list %}
    {% endif %}
    {% set label_list = label_list | map('trim') | reject('equalto', 'invalid') | reject('equalto', '') | list %}
    {{ label_list }}

  entities_from_label_area: >-
    {% set entities_from_label_area = [] %}
    {% set label_area_array = namespace(label_area_list=[]) %}
    {% if label_list != [] %}
      {% set label_area_array.label_area_list = label_list
             | map('label_areas')
             | flatten
             | map('area_entities')
             | expand
             | selectattr('domain', 'in', domains_allowed )
             | selectattr('entity_id', 'is_device_attr', 'manufacturer', 'Inovelli')
             | map(attribute='entity_id')
             | list %}
    {% endif %}
    {% set entities_from_label_area = label_area_array.label_area_list %}
    {{ entities_from_label_area }}

  entities_from_label_device: >-
    {% set entities_from_label_device = [] %}
    {% set label_device_array = namespace(label_device_list=[]) %}
    {% if label_list != [] %}
      {% set label_device_array.label_device_list = label_list 
             | map('label_devices') 
             | flatten 
             | map('device_entities')
             | sum(start=[])
             | select('is_device_attr', 'manufacturer', 'Inovelli')
             | expand
             | map(attribute='entity_id')
             | expand
             | selectattr('domain', 'in', domains_allowed )
             | map(attribute='entity_id')
             | list %}
    {% endif %}
    {% set entities_from_label_device = label_device_array.label_device_list %}
    {{ entities_from_label_device }}

  entities_from_label_entity: >-
    {% set entities_from_label_entity = [] %}
    {% set label_entity_array = namespace(label_entity_list=[]) %}
    {% if label_list != [] %}
      {% set label_entity_array.label_entity_list = label_list
             | map('label_entities')
             | flatten
             | select('is_device_attr', 'manufacturer', 'Inovelli')
             | expand
             | selectattr('domain', 'in', domains_allowed )
             | map(attribute='entity_id')
             | list %}
    {% endif %}
    {% set entities_from_label_entity = label_entity_array.label_entity_list %}
    {{ entities_from_label_entity }}

  entities_from_floor: >-
    {% set entities_from_floor = [] %}
    {% set floor_array = namespace(floor_list=[]) %}
    {% if floor != 'invalid' and floor != ['invalid'] and floor != [] and floor != '' %}
      {% if floor == 'all' %}
        {% set floor_array.floor_list = floors() %}
      {% elif typeof(floor) == 'str' %}
        {% set floor_array.floor_list = floor.split( ',' ) | map('lower') | map('trim') | reject('equalto', 'invalid') | list %}
      {% else %}
        {% set floor_array.floor_list = floor | map('lower') | map('trim') | reject('equalto', 'invalid') | list %}  
      {% endif %}
    {% endif %} 

    {% set entities_from_floor = floor_array.floor_list
           | map('floor_entities') 
           | expand
           | selectattr('domain', 'in', domains_allowed )
           | selectattr('entity_id', 'is_device_attr', 'manufacturer', 'Inovelli')
           | map(attribute='entity_id')
           | list %}
    {{ entities_from_floor }}

  entities_from_area: >-
    {% set entities_from_area = [] %}
    {% set area_array = namespace(area_list=[]) %}
    {% if area != 'invalid' and area != ['invalid'] and area != [] and area != '' %}
      {% if area == 'all' %}
        {% set area_array.area_list = areas() %}
      {% elif typeof(area) == 'str' %}
        {% set area_array.area_list = area.split( ',' ) | map('lower') | map('trim') | reject('equalto', 'invalid') | list %}
      {% else %}
        {% set area_array.area_list = area | map('lower') | map('trim') | reject('equalto', 'invalid') | list %}
      {% endif %}
    {% endif %}

    {% set entities_from_area = area_array.area_list
           | map('area_entities')
           | expand
           | selectattr('domain', 'in', domains_allowed )
           | selectattr('entity_id', 'is_device_attr', 'manufacturer', 'Inovelli')
           | map(attribute='entity_id')
           | list %}
    {{ entities_from_area }}

  entities_from_group: >-
    {% set entities_from_group = [] %}
    {% set group_array = namespace(group_list=[]) %}
    {% if group != 'invalid' and group != ['invalid'] and group != [] and group != '' %}
      {% if typeof(group) == 'str' %}
        {% set group_array.group_list = group.split( ',' ) | map('lower') | map('trim') | list %}
      {% else %}
        {% set group_array.group_list = group | map('lower') | map('trim') | list %}
      {% endif %}
    {% endif %}
    {% set entities_from_group = group_array.group_list
           | expand
           | selectattr('domain', 'in', domains_allowed )
           | selectattr('entity_id', 'is_device_attr', 'manufacturer', 'Inovelli')
           | map(attribute='entity_id')
           | list %}
    {{ entities_from_group }}

  entities_from_device: >-
    {% set entities_from_device = [] %}
    {% set device_array = namespace(device_list=[]) %}
    {% if device != 'invalid' and device != ['invalid'] and device != [] and device != '' %}
      {% if typeof(device) == 'str' %}
        {% set device_array.device_list = device.split( ',' ) | map('lower') | map('trim') | list %}
      {% else %}
        {% set device_array.device_list = device | map('lower') | map('trim') | list %}
      {% endif %}
    {% endif %}

    {% set entities_from_device = device_array.device_list
           | map('device_entities')
           | sum(start=[])
           | select('is_device_attr', 'manufacturer', 'Inovelli')
           | expand
           | map(attribute='entity_id')
           | expand
           | selectattr('domain', 'in', domains_allowed )
           | map(attribute='entity_id')
           | list %}
    {{ entities_from_device }}

  entities_from_entity: >-
    {% set entities_from_entity = [] %}
    {% set entity_array = namespace(entity_list=[]) %}
    {% if entity != 'invalid' and entity != ['invalid'] and entity != [] and entity != '' %}
      {% if typeof(entity) == 'str' %}
        {% set entity_array.entity_list = entity.split( ',' ) | map('lower') | map('trim') | list %}
      {% else %}
        {% set entity_array.entity_list = entity | map('lower') | map('trim') | list %}
      {% endif %}
    {% endif %}

    {% set entities_from_entity = entity_array.entity_list
           | select('is_device_attr', 'manufacturer', 'Inovelli')
           | expand
           | selectattr('domain', 'in', domains_allowed )
           | map(attribute='entity_id')
           | list %}
    {{ entities_from_entity }}

  all_selected_entities: >-
    {% set all_selected_entities = [] %}
    {% set selectors = [ entities_from_domain,
                         entities_from_label_area,
                         entities_from_label_device,
                         entities_from_label_entity,
                         entities_from_floor,
                         entities_from_area,
                         entities_from_group,
                         entities_from_device,
                         entities_from_entity ]
                         | reject('equalto', [])
                         | list %}
    {% if selector_mode == 'all' %}
      {% set selector_array = namespace(selector_list=selectors[0]) %}
      {% for i in range(0,selectors|count) %}
        {% set selector_array.selector_list = intersect(selectors[i], selector_array.selector_list) %}
      {% endfor %}
      {% set all_selected_entities = selector_array.selector_list %}
    {% else %}
      {% set all_selected_entities = selectors | flatten | unique | list %}
    {% endif %}
    {{ all_selected_entities }}


sequence:

  ##################
  # Cleaning up other variables; using lower case since it's able to handle capital letters in the middle of mistyped and camelcase words like "LightPink".
  # Brightness variables are set to 11 so they're skipped in the logic.  To turn the LED off, use "Off".
  ##################
  - variables:
      selector_mode:   "{{ selector_mode }}"
      z2m_topic:       "{{ z2m_topic }}"
      domains_allowed: "{{ domains_allowed }}"
      domain:          "{{ domain }}"
      label:           "{{ label }}"
      floor:           "{{ floor }}"
      area:            "{{ area }}"
      group:           "{{ group }}"
      device:          "{{ device }}"
      entity:          "{{ entity }}"

      LEDnumber:         "{{ LEDnumber         | default('all')          | lower }}"
      LEDcolor:          "{{ LEDcolor          | default('no change')    | lower }}"
      LEDcolor_off:      "{{ LEDcolor_off      | default('no change')    | lower }}"
      LEDbrightness:     "{{ LEDbrightness     | default(11)             | float }}"
      LEDbrightness_off: "{{ LEDbrightness_off | default(11)             | float }}"
      LEDnumber_effect:  "{{ LEDnumber_effect  | default('all')          | lower }}"
      effect:            "{{ effect            | default('clear effect') | lower }}"
      brightness:        "{{ brightness        | default(11)             | float }}"
      color:             "{{ color             | default('no change')    | lower }}"
      duration:          "{{ duration          | default(0)              | lower }}"


  ##################
  # Group entities by device type so the right integration and parameters can be used
  ##################
  - repeat:
      for_each:

        ##################
        # ZHA Zigbee Home Automation
        ##################
        - device_type: VZM30SN
          call_type: zha
          effects: "{{ iif(LEDnumber_effect == 'all',VZM30SN_ZHA_all_effects[effect],VZM30SN_ZHA_led_effects[effect]) }}" ### So we can pass the device-specific effect into the repeat loop ###
          entities: >-
            {% set entities = namespace(entities=[]) %}
            {% for ent in all_selected_entities %}
              {% if 'VZM30-SN' in device_attr(ent,'model') and ent.split('.')[0] == 'light' and ent in integration_entities('zha') %}
                {% set entities.entities = entities.entities + [ent] %} #                {% set entities.entities = entities.entities + [(device_attr( ent, 'identifiers') | list).0.1] %} 
              {% endif %}
            {% endfor %}
            {{ entities.entities }}

        - device_type: VZM31SN
          call_type: zha
          effects: "{{ iif(LEDnumber_effect == 'all',VZM31SN_ZHA_all_effects[effect],VZM31SN_ZHA_led_effects[effect]) }}" ### So we can pass the device-specific effect into the repeat loop ###
          entities: >-
            {% set entities = namespace(entities=[]) %}
            {% for ent in all_selected_entities %}
              {% if 'VZM31-SN' in device_attr(ent,'model') and ent.split('.')[0] == 'light' and ent in integration_entities('zha') %}
                {% set entities.entities = entities.entities + [ent] %}
              {% endif %}
            {% endfor %}
            {{ entities.entities }}

        - device_type: VZM35SN
          call_type: zha
          effects: "{{ iif(LEDnumber_effect == 'all',VZM35SN_ZHA_all_effects[effect],VZM35SN_ZHA_led_effects[effect]) }}" ### So we can pass the device-specific effect into the repeat loop ###
          entities: >-
            {% set entities = namespace(entities=[]) %}
            {% for ent in all_selected_entities %}
              {% if 'VZM35-SN' in device_attr(ent,'model') and ent.split('.')[0] == 'fan' and ent in integration_entities('zha') %}
                {% set entities.entities = entities.entities + [ent] %}
              {% endif %}
            {% endfor %}
            {{ entities.entities }}


      sequence:
        ##################
        # Do not continue if we don't have at least one entity of this type
        ##################
        - condition: template
          value_template: "{{ (repeat.item.entities | count >0) or (repeat.item.effect_entities | count >0) }}"

        ##################
        # LED strip color
        ##################
        - choose:
            - conditions: "{{ LEDcolor != 'no change' }}"
              sequence:

                ### ZHA ###
                - choose:
                    - conditions: "{{ repeat.item.call_type == 'zha' }}"
                      sequence:
                        - repeat:
                            for_each: "{{ repeat.item.entities  | select('match', domains_allowed) | list }}"
                            sequence:
                              - choose:
                                  ### Configuring a color set for all LEDs ###
                                  - conditions: "{{ 'all' in LEDcolor and LEDnumber == 'all' }}"
                                    sequence:
                                      - variables:
                                          entity: "{{ repeat.item | select('match', domains_allowed) | list }}"
                                      - repeat:
                                          for_each:
                                            - "led 1"
                                            - "led 2"
                                            - "led 3"
                                            - "led 4"
                                            - "led 5"
                                            - "led 6"
                                            - "led 7"
                                            - "all"
                                          sequence:
                                            - service: zha.set_zigbee_cluster_attribute
                                              continue_on_error: true
                                              data:
                                                ieee: "{{ (device_attr( entity, 'identifiers') | list).0.1 }}"
                                                endpoint_id: 1
                                                cluster_id: 64561
                                                cluster_type: in
                                                attribute: >-
                                                  {% if repeat.item == 'all' %}
                                                    {{ 0x005f |int }}
                                                  {% elif repeat.item == 'led 1' %}
                                                    {{ 0x003c |int }}
                                                  {% elif repeat.item == 'led 2' %}
                                                    {{ 0x0041 |int }}
                                                  {% elif repeat.item == 'led 3' %}
                                                    {{ 0x0046 |int }}
                                                  {% elif repeat.item == 'led 4' %}
                                                    {{ 0x004b |int }}
                                                  {% elif repeat.item == 'led 5' %}
                                                    {{ 0x0050 |int }}
                                                  {% elif repeat.item == 'led 6' %}
                                                    {{ 0x0055 |int }}
                                                  {% elif repeat.item == 'led 7' %}
                                                    {{ 0x005a |int }}
                                                  {% endif %}
                                                value: "{{ color_set[LEDcolor][repeat.item] }}"
                                                manufacturer: 4655
                                  ### Configuring just one LED or the full bar ###
                                  - conditions: "{{ 'all' not in LEDcolor and LEDcolor != 'no change' }}"
                                    sequence:
                                      - service: zha.set_zigbee_cluster_attribute
                                        continue_on_error: true
                                        data:
                                          ieee: "{{ (device_attr( repeat.item, 'identifiers') | list).0.1 }}"
                                          endpoint_id: 1
                                          cluster_id: 64561
                                          cluster_type: in
                                          attribute: >-
                                            {% if LEDnumber == 'all' %}
                                              {{ 0x005f |int }}
                                            {% elif LEDnumber == 'led 1' %}
                                              {{ 0x003c |int }}
                                            {% elif LEDnumber == 'led 2' %}
                                              {{ 0x0041 |int }}
                                            {% elif LEDnumber == 'led 3' %}
                                              {{ 0x0046 |int }}
                                            {% elif LEDnumber == 'led 4' %}
                                              {{ 0x004b |int }}
                                            {% elif LEDnumber == 'led 5' %}
                                              {{ 0x0050 |int }}
                                            {% elif LEDnumber == 'led 6' %}
                                              {{ 0x0055 |int }}
                                            {% elif LEDnumber == 'led 7' %}
                                              {{ 0x005a |int }}
                                            {% endif %}
                                          ### Individual LEDs use 255 for 'off' while it's 'white' for the LED bar ###
                                          value: >-
                                            {% if 'led' in LEDnumber and LEDcolor == 'off' %}
                                              255
                                            {% else %}
                                              {{ color_set[LEDcolor] }}
                                            {% endif %}
                                          manufacturer: 4655


        ##################
        # LED strip color when off
        ##################
        - choose:
            - conditions: "{{ LEDcolor_off != 'no change' }}"
              sequence:

                ### ZHA ###
                - choose:
                    - conditions: "{{ repeat.item.call_type == 'zha' }}"
                      sequence:
                        - repeat:
                            for_each: "{{ repeat.item.entities | select('match', domains_allowed) | list }}"
                            sequence:
                              - choose:
                                  ### Configuring a color set for all LEDs ###
                                  - conditions: "{{ 'all' in LEDcolor_off and LEDnumber == 'all' }}"
                                    sequence:
                                      - variables:
                                          entity: "{{ repeat.item | select('match', domains_allowed) | list }}"
                                      - repeat:
                                          for_each:
                                            - "led 1"
                                            - "led 2"
                                            - "led 3"
                                            - "led 4"
                                            - "led 5"
                                            - "led 6"
                                            - "led 7"
                                            - "all"
                                          sequence:
                                            - service: zha.set_zigbee_cluster_attribute
                                              continue_on_error: true
                                              data:
                                                ieee: "{{ (device_attr( entity, 'identifiers') | list).0.1 }}"
                                                endpoint_id: 1
                                                cluster_id: 64561
                                                cluster_type: in
                                                attribute: >-
                                                  {% if repeat.item == 'all' %}
                                                    {{ 0x0060 |int }}
                                                  {% elif repeat.item == 'led 1' %}
                                                    {{ 0x003d |int }}
                                                  {% elif repeat.item == 'led 2' %}
                                                    {{ 0x0042 |int }}
                                                  {% elif repeat.item == 'led 3' %}
                                                    {{ 0x0047 |int }}
                                                  {% elif repeat.item == 'led 4' %}
                                                    {{ 0x004c |int }}
                                                  {% elif repeat.item == 'led 5' %}
                                                    {{ 0x0051 |int }}
                                                  {% elif repeat.item == 'led 6' %}
                                                    {{ 0x0056 |int }}
                                                  {% elif repeat.item == 'led 7' %}
                                                    {{ 0x005b |int }}
                                                  {% endif %}
                                                value: "{{ color_set[LEDcolor_off][repeat.item] }}"
                                                manufacturer: 4655
                                  ### Configuring just one LED or the full bar ###
                                  - conditions: "{{ 'all' not in LEDcolor_off and LEDcolor_off != 'no change' }}"
                                    sequence:
                                      - service: zha.set_zigbee_cluster_attribute
                                        continue_on_error: true
                                        data:
                                          ieee: "{{ (device_attr( repeat.item, 'identifiers') | list).0.1 }}"
                                          endpoint_id: 1
                                          cluster_id: 64561
                                          cluster_type: in
                                          attribute: >-
                                            {% if LEDnumber == 'all' %}
                                              {{ 0x0060 |int }}
                                            {% elif LEDnumber == 'led 1' %}
                                              {{ 0x003d |int }}
                                            {% elif LEDnumber == 'led 2' %}
                                              {{ 0x0042 |int }}
                                            {% elif LEDnumber == 'led 3' %}
                                              {{ 0x0047 |int }}
                                            {% elif LEDnumber == 'led 4' %}
                                              {{ 0x004c |int }}
                                            {% elif LEDnumber == 'led 5' %}
                                              {{ 0x0051 |int }}
                                            {% elif LEDnumber == 'led 6' %}
                                              {{ 0x0056 |int }}
                                            {% elif LEDnumber == 'led 7' %}
                                              {{ 0x005b |int }}
                                            {% endif %}
                                          ### Individual LEDs use 255 for 'off' while it's 'white' for the LED bar ###
                                          value: >-
                                            {% if 'led' in LEDnumber and LEDcolor_off == 'off' %}
                                              255
                                            {% else %}
                                              {{ color_set[LEDcolor_off] }}
                                            {% endif %}
                                          manufacturer: 4655


        ##################
        # LED strip brightness
        ##################
        - choose:
            - conditions: "{{ LEDbrightness is defined and int(LEDbrightness) != 11 }} "
              sequence:

                ### ZHA ###
                - choose:
                    - conditions: "{{ repeat.item.call_type == 'zha' }}"
                      sequence:
                        - repeat:
                            for_each: "{{ repeat.item.entities | select('match', domains_allowed) | list }}"
                            sequence:
                              - choose:
                                  ### Configuring a color set for all LEDs ###
                                  - conditions: "{{ int(LEDbrightness) != 11 and LEDnumber == 'all' and 'all' in LEDcolor }}"
                                    sequence:
                                      - variables:
                                          entity: "{{ repeat.item | select('match', domains_allowed) | list }}"
                                      - repeat:
                                          for_each:
                                            - "led 1"
                                            - "led 2"
                                            - "led 3"
                                            - "led 4"
                                            - "led 5"
                                            - "led 6"
                                            - "led 7"
                                            - "all"
                                          sequence:
                                            - service: zha.set_zigbee_cluster_attribute
                                              continue_on_error: true
                                              data:
                                                ieee: "{{ (device_attr( entity, 'identifiers') | list).0.1 }}"
                                                endpoint_id: 1
                                                cluster_id: 64561
                                                cluster_type: in
                                                attribute: >-
                                                  {% if repeat.item == 'all' %}
                                                    {{ 0x0061 |int }}
                                                  {% elif repeat.item == 'led 1' %}
                                                    {{ 0x003e |int }}
                                                  {% elif repeat.item == 'led 2' %}
                                                    {{ 0x0043 |int }}
                                                  {% elif repeat.item == 'led 3' %}
                                                    {{ 0x0048 |int }}
                                                  {% elif repeat.item == 'led 4' %}
                                                    {{ 0x004d |int }}
                                                  {% elif repeat.item == 'led 5' %}
                                                    {{ 0x0052 |int }}
                                                  {% elif repeat.item == 'led 6' %}
                                                    {{ 0x0057 |int }}
                                                  {% elif repeat.item == 'led 7' %}
                                                    {{ 0x005c |int }}
                                                  {% endif %}
                                                value: "{{ iif(LEDcolor == 'all clear' and 'led' in repeat.item,101,(LEDbrightness * 10)) | int }}"
                                                manufacturer: 4655
                                  ### Configuring just one LED or the full bar ###
                                  - conditions: "{{ int(LEDbrightness) != 11 and LEDnumber != 'all' or 'all' not in LEDcolor }}"
                                    sequence:
                                      - service: zha.set_zigbee_cluster_attribute
                                        continue_on_error: true
                                        data:
                                          ieee: "{{ (device_attr( repeat.item, 'identifiers') | list).0.1 }}"
                                          endpoint_id: 1
                                          cluster_id: 64561
                                          cluster_type: in
                                          attribute: >-
                                            {% if LEDnumber == 'all' %}
                                              {{ 0x0061 |int }}
                                            {% elif LEDnumber == 'led 1' %}
                                              {{ 0x003e |int }}
                                            {% elif LEDnumber == 'led 2' %}
                                              {{ 0x0043 |int }}
                                            {% elif LEDnumber == 'led 3' %}
                                              {{ 0x0048 |int }}
                                            {% elif LEDnumber == 'led 4' %}
                                              {{ 0x004d |int }}
                                            {% elif LEDnumber == 'led 5' %}
                                              {{ 0x0052 |int }}
                                            {% elif LEDnumber == 'led 6' %}
                                              {{ 0x0057 |int }}
                                            {% elif LEDnumber == 'led 7' %}
                                              {{ 0x005c |int }}
                                            {% endif %}
                                          value: "{{ iif(LEDcolor == 'all clear',101,(LEDbrightness * 10)) | int }}"
                                          manufacturer: 4655


        ##################
        # LED strip brightness when off
        ##################
        - choose:
            - conditions: "{{ LEDbrightness_off is defined and int(LEDbrightness_off) != 11 }} "
              sequence:

                ### ZHA ###
                - choose:
                    - conditions: "{{ repeat.item.call_type == 'zha' }}"
                      sequence:
                        - repeat:
                            for_each: "{{ repeat.item.entities | select('match', domains_allowed) | list }}"
                            sequence:
                              - choose:
                                    ### Configuring a color set for all LEDs ###
                                  - conditions: "{{ int(LEDbrightness_off) != 11 and LEDnumber == 'all' and 'all' in LEDcolor_off }}"
                                    sequence:
                                      - variables:
                                          entity: "{{ repeat.item | select('match', domains_allowed) | list }}"
                                      - repeat:
                                          for_each:
                                            - "led 1"
                                            - "led 2"
                                            - "led 3"
                                            - "led 4"
                                            - "led 5"
                                            - "led 6"
                                            - "led 7"
                                            - "all"
                                          sequence:
                                            - service: zha.set_zigbee_cluster_attribute
                                              continue_on_error: true
                                              data:
                                                ieee: "{{ (device_attr( entity, 'identifiers') | list).0.1 }}"
                                                endpoint_id: 1
                                                cluster_id: 64561
                                                cluster_type: in
                                                attribute: >-
                                                  {% if repeat.item == 'all' %}
                                                    {{ 0x0062 |int }}
                                                  {% elif repeat.item == 'led 1' %}
                                                    {{ 0x003f |int }}
                                                  {% elif repeat.item == 'led 2' %}
                                                    {{ 0x0044 |int }}
                                                  {% elif repeat.item == 'led 3' %}
                                                    {{ 0x0049 |int }}
                                                  {% elif repeat.item == 'led 4' %}
                                                    {{ 0x004e |int }}
                                                  {% elif repeat.item == 'led 5' %}
                                                    {{ 0x0053 |int }}
                                                  {% elif repeat.item == 'led 6' %}
                                                    {{ 0x0058 |int }}
                                                  {% elif repeat.item == 'led 7' %}
                                                    {{ 0x005d |int }}
                                                  {% endif %}
                                                value: "{{ iif(LEDcolor_off == 'all clear' and 'led' in repeat.item,101,(LEDbrightness_off * 10)) | int }}"  
                                                manufacturer: 4655
                                    ### Configuring just one Color ###
                                  - conditions: "{{ int(LEDbrightness_off) != 11 and LEDnumber != 'all' or 'all' not in LEDcolor_off }}"
                                    sequence:
                                      - service: zha.set_zigbee_cluster_attribute
                                        continue_on_error: true
                                        data:
                                          ieee: "{{ (device_attr( repeat.item, 'identifiers') | list).0.1 }}"
                                          endpoint_id: 1
                                          cluster_id: 64561
                                          cluster_type: in
                                          attribute: >-
                                            {% if LEDnumber == 'all' %}
                                              {{ 0x0062 |int }}
                                            {% elif LEDnumber == 'led 1' %}
                                              {{ 0x003f |int }}
                                            {% elif LEDnumber == 'led 2' %}
                                              {{ 0x0044 |int }}
                                            {% elif LEDnumber == 'led 3' %}
                                              {{ 0x0049 |int }}
                                            {% elif LEDnumber == 'led 4' %}
                                              {{ 0x004e |int }}
                                            {% elif LEDnumber == 'led 5' %}
                                              {{ 0x0053 |int }}
                                            {% elif LEDnumber == 'led 6' %}
                                              {{ 0x0058 |int }}
                                            {% elif LEDnumber == 'led 7' %}
                                              {{ 0x005d |int }}
                                            {% endif %}
                                          value: "{{ iif(LEDcolor_off == 'all clear',101,(LEDbrightness_off * 10)) | int }}"
                                          manufacturer: 4655


        #################
        # Effects (fully defined)
        # Calling a bulk set of parameters reduces Z-Wave traffic and writes to the switch's NVRAM, extending its life(?)
        # Duration defaults to 0sec, so it's no longer required for this flow.
        ##################
        - choose:
            - conditions: >-
                {{ effect != "off" and effect != "clear effect" and color != "no change" and int(brightness) != 11 and
                   repeat.item.device_type != "LZW30" and repeat.item.device_type != "LZW31" }}
              sequence:

                ### ZHA ###
                - choose:
                    - conditions: "{{ repeat.item.call_type == 'zha' }}"
                      sequence:
                        - variables:
                            effects: "{{ repeat.item.effects }}"
                        - repeat:
                            for_each: "{{ repeat.item.entities | select('match', domains_allowed) | list }} "
                            sequence:
                              - service: zha.issue_zigbee_cluster_command
                                continue_on_error: true
                                data:
                                  ieee: "{{ (device_attr(repeat.item, 'identifiers')|list).0.1 }}"
                                  endpoint_id: 1
                                  cluster_id: 64561
                                  cluster_type: in
                                  command: "{{ iif('all' in LEDnumber_effect,1,3) }}"
                                  command_type: server
                                  params: {"led_number":"{{ led_map[LEDnumber_effect]|int }}","led_effect":"{{ effects }}","led_color":"{{ color_set[color] }}","led_level":"{{ (brightness * 10) | int }}","led_duration":"{{ duration_values[duration] }}"}
                                  manufacturer: 4655


          default:
            ##################
            # Default will be to clear the effect and set the duration to 1 second.
            # This way, "forever" effects can be set, then easily cleared.
            # It's also a safer way to fail since the worst case scenario is that an effect is cleared.
            # Setting only the effect to "off" turned the LED off on LZW36 fan / light combos for the duration (which could be "forever").
            #    This way it turns off for 1 sec before it returns to its default state, but until the min value for effect changes to 0 in the DB, that's the best I can do.
            ##################

            ### Zwave JS ###
            - choose:

            ### ZHA ###
            - choose:
                - conditions: "{{ repeat.item.call_type == 'zha' }}"
                  sequence:
                    - variables:
                        effects: "{{ repeat.item.effects }}"
                    - repeat:
                        for_each: "{{ repeat.item.entities | select('match', domains_allowed) | list }} "
                        sequence:
                          - service: zha.issue_zigbee_cluster_command
                            continue_on_error: true
                            data:
                              ieee: "{{ (device_attr(repeat.item, 'identifiers')|list).0.1 }}"
                              endpoint_id: 1
                              cluster_id: 64561
                              cluster_type: in
                              command: "{{ iif('all' in LEDnumber_effect,1,3) }}"
                              command_type: server
                              params: {"led_number":"{{ led_map[LEDnumber_effect]|int }}","led_effect":"{{ effects }}","led_color":0,"led_level":0,"led_duration":"{{ duration_values[duration] }}"}
                              manufacturer: 4655
